# 蟹卡


## 用户模块
用户分为三类：商城用户、提货用户、后台管理用户

后端用户管理是针对商城用户、提货用户两类用户的管理。
![[IMG-20250630142651183.png]]

小程序端用户个人功能：
个人信息：
![[IMG-20250630143458347.png]]

收货地址：
![[IMG-20250630143509925.png]]



## 商品模块

商品分为三类：商品（正常的商品，发物流给客户）、商品卡劵（绑定商品，实物卡，用户可以兑换）、电子卡劵（绑定商品，用户线上输入卡号卡密激活使用）

### 商品属性
商品属性是商品针对规格可选的，例如这里示例的公母属性，那么商品可选的规格就是公蟹、母蟹、公母蟹，商品属性是商品很重要的一个东西，后面商品如果选了分类，那么商品的规格就是从属性中带出来的，也就是商品可选的类型，必须是属性中定义的。
示例：下面定义了两个属性，分别是公母、只数，公母、只数可选的规格的规格如图
![[IMG-20250624173621504.png]]
商品属性添加，输入自定义属性的类别、属性可选的规格选项
![[IMG-20250624174157449.png]]

### 商品分类
**商品分类：** 商品有类别，这个分类是管理员后台自定义的类别，不同于商品的上面三大类
这里创建好分类，那么分类就和属性就是一对多的关系了，如果商品创建的时候选好分类，那么可选的属性规格就是分类带出来的。
1. 商品分类列表页面：分类类型、分类名称、分类图片...
![[IMG-20250624171649470.png]]
2. 添加商品分类：这里选择的分类类型是三类（商品、商品卡劵、电子卡劵），属性类别关联商品属性，关联分类能选的属性规格
![[IMG-20250624171855691.png]]
### 商品信息
商品列表：
![[IMG-20250624175958592.png]]

添加商品：商品类别关联上面商品分类，可选的商品规格都是分类带过来的属性，可以创建多个商品的规格。
![[IMG-20250624181203908.png]]


添加商品卡劵：
商品类别选的是商品的三大类还是自定义的分类？（这里选分类是不对的）
选择商品关联创建的卡劵，商品规格自动带入，因为创建的卡劵选择了规格
![[IMG-20250624181319499.png]]

添加电子卡劵：和上面一样
![[IMG-20250624181416175.png]]

商家评论：查看商品所有关联的评论信息，评论来自于用户对商品购买后的评价，这里商家可对用户评价进行回复
![[IMG-20250624181502153.png]]

设置预约：？
![[IMG-20250624181534924.png]]


小程序端针对商品：
查看商品：
![[IMG-20250629222252396.png]]
商品详情：
![[IMG-20250629222330130.png]]
商品评价：查看已购买用户对商品的评价
![[IMG-20250629222340631.png]]
加入购物车：
![[IMG-20250629222410772.png]]
商品购买：
![[IMG-20250629222442069.png]]


## 提货模块
提货：针对商品卡劵和电子卡劵两类，用户购买了该商品卡劵和电子卡劵的商品应该给用户分配该商品对应的卡劵信息
提货创建提货订单。
![[IMG-20250704114058564.png]]



## 购物车模块
添加购物车：添加具体的商品（三类），添加的时候会将信息都存入购物车表中

购物车购买：购买



## 卡劵管理
**卡劵管理模块开发：**
业务梳理：
- 卡劵需要和商品做关联（商品有不同的规格，需要和不同规格商品做关联），添加的话是添加一批卡劵，**关于卡劵和商品的数量是否要对的上，尚不清楚**（也就是说商品规格的库存是100，那么我创建对应的卡劵数量是101，那么此时不够是不是不允许创建，我这里创建卡劵只是关联，并不会去扣减商品规格的库存，只做了关联！！！）
- 关于提货规格，如果选择的是分两次提或者是"一次全提/分两次提"，那么就需要去填写提货规格，提货规格的意义在于用户第一次提货可以按照卡劵设定的提货规格去选，第二次提货就是根据商品规格的数量自动算出第二次提要提的数量。
- 卡券激活状态分为手动激活和自动激活
自动激活：默认未激活，根据物流状态显示已签收后自动激活；未收货退款还是未激活状态；已收货未使用退款自动变为已失效状态，撤销退款变为原始状态
- 卡劵可以提货的日期？

小程序端我的卡包模块？未实现

卡劵管理首页面：
![[IMG-20250610120133908.png]]
添加/编辑页面：编辑，一批卡劵中有修改的卡劵，不允许修改
![[IMG-20250610120159391.png]]
卡劵详情页面：
![[IMG-20250610120215662.png]]

## 订单、退款售后模块
商品种类：商品、商品卡劵（需要发货）、电子卡劵
```java
数据库订单表关于订单状态的定义：
1. 支付状态：待支付1、支付成功2、订单失效3、退款4
2. 退款状态：退款中1、退款完成2、退款失败3
3. 物流状态：待发货1、待发货2，待评价3、已评价4

业务层面定义一个总的订单状态： 
1待付款 2取消订单 3待发货 4待收货 5待评价 6已评价 7待退款 8 退款成功 9退款失败
```

```java
微信支付流程：
  1. 调用后端支付接口创建订单数据，返回支付参数给前端
  2. 前端通过支付参数调起支付，显示支付页面
  3. 微信支付后台通过回调地址通知商户是否支付成功，也可以主动去查找订单状态
```

订单模块（小程序端）：
### 创建订单/商品购买
创建订单：创建订单的操作都是发生在小程序端，用户去购买商品或者购物车购买
- 商品购买，直接购买单个的商品，创建单个订单
- 购物车购买，多选商品就创建多个订单

#### 点击购买商品，创建订单
创建订单，此时只设置订单状态为待支付，订单有效期为30分钟
后端接口：/order/createOrder

#### 订单支付
校验订单的有效期，调用微信官方支付接口，发起支付，生成预支付交易单，发送给前端
后端接口：/order/saveOrder


#### 支付回调
接口：/api/pay/callback
1. 支付成功：扣减库存，订单传给ERP，创建销售单，设置订单状态为支付成功，物流状态为待发货。
2. 支付失败：返回失败信息，订单状态还是处于待支付状态

```java
创建销售单调用ERP接口，成功返回一个销售单号，存入数据库中。
```
![[IMG-20250704163559489.png]]

### 定时任务：调用ERP实时更新订单的物流状态
业务逻辑：查询所有的处理中的销售单，调用接口查询销售单，为了获取销售单的物流单号（因为销售单关于发货这一块操作都是在ERP后台进行操作），如果有物流单号，那么再调用ERP接口获取物流轨迹信息，存入数据库中。

第二个定时任务：获取处理中的销售单，查询销售单对应的最新的物流信息，根据物流信息状态判断订单的物流状态（待收货、待发货、待评价、已评价），关于物流的设置都在这个定时任务中去设置，订单支付状态还是成功（2），物流状态可变待发货（2）、待评价（3）


### 定时任务：调用ERP拉取唯一码
针对商品卡劵，用户会在ERP中输入卡劵的唯一码，定时任务拉取唯一码，针对 



### 立即付款
/order/immediatePayment/{orderId}
针对待付款的订单，发起微信支付，给微信下单接口发送请求，得到预支付交易码，传递给前端，支付回调中见修改状态。


### 订单评价
针对待评价的订单发起订单评价，评价成功修改订单状态为“支付成功(2)”“已评价(4)”
/order/evaluate


### 退款
退款：针对已经付款（3待发货 4待收货 5待评价 6已评价 9退款失败）的订单可以发送退款
- 创建退款售后订单
- 撤销退款售后
- 查询退款售后订单
- 商家处理（驳回/确认退款）

**创建退款售后订单（小程序端）：**
```java
支付成功的订单、退款失败的订单都可以发起退款。

订单进入退款状态(4)，待退款(1)，并且创建订单退款记录
```

撤销订单退款（小程序）：
```java
订单恢复支付成功状态(2)，退款状态清空为0,订单退款记录经历过取消状态
```

**查询售后订单**：
```java
查询所有已处理和未处理的售后订单
```

**商家处理退款（后台）：**
```java
同意：订单还是退款状态(4)，退款成功(2)
不同意：订单回复支付成功状态(2)，退款状态变为"退款失败(3)"
```



### 订单操作
订单操作：
- 默认展示全部状态的订单(待付款、取消订单、待发货、待收货、待评价、已评价)
- 订单失效情况（超时未支付、用户取消）修改“订单状态”为“取消订单(3)”
- 订单详情页面

### 商品订单（后台）：
- 查询订单和订单详情接口
![[IMG-20250622222332066.png]]
![[IMG-20250622222347963.png]]
- 关于售后处理的接口
![[IMG-20250622222324490.png]]




## 发票模块
### 申请发票
小程序端：发票
针对订单（现在是针对已经支付成功的订单）开发票（发票对接ERP创建发票单，返回开票结果）
![[IMG-20250627174144784.png]]

### 发票详情





### 后台发票管理
后台：开票管理：展示所有已开票、未开票、开票失败的订单
![[IMG-20250622224815240.png]]




## 数据统计分析模块

默认展示所有商城商品总销售额、销售总量、卡券核销总量信息
![[IMG-20250622224907451.png]]










## 对接第三方

物流：
1. 创建发货单，订单支付回调创建发货单（调用ERP接口）
2. 定时任务，销售单查询（调用接口），获取销售单存入订单销售单关联表，获取物流轨迹信息（调用接口），插入物流轨迹最新信息到订单物流表
3. 物流查询就根据订单编号查询订单物流表

开票：
1. 小程序申请发票，根据网店订单号和开票资料创建开票申请单(调用接口)，可以获得是否开票成功
2. 查询开票结果，为了获得开票票据地址
3. 红冲，查询红冲结果，红冲ERP进行处理，这里需要获得ERP发票状态

